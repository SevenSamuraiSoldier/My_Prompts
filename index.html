<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>AI Prompt Database</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <style>
            :root {
                --bg-main: #181c20;
                --bg-card: #23272c;
                --bg-modal: #272b30;
                --bg-detail: #21252b;
                --accent: #3997ed;
                --text-main: #eceeee;
                --text-secondary: #b6bac1;
                --prompt-main: #323a45;
                --prompt-secondary: #303943;
                --final: #355378;
                --shadow: 0 2px 10px #000a;
                --expand-btn-svg-size: 30px;
            }
            body {
                font-family: Arial, sans-serif;
                background: var(--bg-main);
                margin: 0;
                color: var(--text-main);
                box-sizing: border-box;
            }
            .container {
                /* max-width: 700px; */
                margin: auto;
                padding: 2em;
                /* padding: 2em; */
                /* display: flex; */
                /* flex-direction: row;
                flex-wrap: wrap; */
                /* align-content: center; */
                justify-content: center;
            }
            #cardsContainer {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                align-content: center;
                justify-content: space-evenly;
                align-items: center;
                column-gap: 0.25rem;
            }
            .addBtn-container {
                display: flex;
                align-items: center;
                align-content: center;
                flex-wrap: wrap;
                position: relative;
            }
            .plus-btn {
                font-size: 2em;
                width: 45px;
                height: 45px;
                border-radius: 50%;
                border: none;
                background: var(--accent);
                color: #dddddd;
                cursor: pointer;
                margin-block: 0.5em;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
            }
            .plus-btn svg {
                fill: #dddddd;
            }
            #prompt-count-text {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: #8fb1cf;
                font-weight: 700;
            }
            #searchInput {
                padding-block: 1rem;
                padding-inline: 1rem;
                color: var(--text-secondary);
            }
            #searchInput:focus-visible {
                outline: 2px solid #3d3d3d;  
            }
            .card {
                background: var(--bg-card);
                box-shadow: var(--shadow);
                border-radius: 10px;
                overflow: hidden;
                position: relative;
                margin-bottom: 2em;
                /* text-align: center; */
                display: flex;
                flex-direction: column;
                align-content: center;
                align-items: center;
                justify-content: center;
                flex-wrap: wrap;
            }
            .card img {
                display: block;
                width: auto;
                max-width: 100%;
                height: 400px;
                object-fit: contain;
                background: #111;
                margin-top: 1rem;
                border-radius: 0.5rem;
            }
            .card .title {
                padding-block: 0.75rem;
                padding-inline: 1rem;
                font-weight: 700;
                /* font-size: 1.25em; */
                font-size: 1rem;
                color: var(--accent);
                width: 100%;
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                align-content: center;
                justify-content: space-around;
                align-items: center;
                text-align: center;
            }
            .expand-btn {
                /* position: absolute;
                top: 50%;
                transform: translateY(-50%);
                right: 5%; */
                background: none;
                border: none;
                /* padding: 0.5em; */
                cursor: pointer;
                font-size: 1.5em;
                color: var(--accent);
                display: flex;
                align-content: center;
                justify-content: center;
                align-items: center;
                flex-wrap: wrap;
                padding: 0;
            }
            .expand-btn svg {
                width: var(--expand-btn-svg-size);
                height: var(--expand-btn-svg-size);
            }
            .rotate-svg-180 {
                transform: rotate(180deg);
                transform-origin: 50% 50%;
            }

            .modal {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(20, 23, 28, 0.7);
                display: flex;
                align-items: center;
                justify-content: flex-start;
                z-index: 111;
                flex-direction: column;
            }
            .modal-content {
                background: var(--bg-modal);
                border-radius: 10px;
                padding: 2em;
                min-width: 320px;
                position: relative;
                color: var(--text-main);
                box-shadow: var(--shadow);
            }
            #modalForm input {
                padding-block: 0.25rem;
                padding-inline: 0.5rem;
                font-size: 0.875rem;
            }
            #modalForm textarea {
                margin-top: 0.15rem;
            }
            #photoInput {
                margin-block: 1rem;
            }
            #aiNameInput, #modelNameInput, #editModalForm Input, #rating {
                margin-bottom: 1em;
                box-sizing: border-box;
                background: var(--bg-detail);
                color: var(--text-main);
                border: 1px solid #222;
                border-radius: 6px;
    
            }
            .close {
                position: absolute;
                top: 12px;
                right: 15px;
                font-size: 2em;
                color: #aaa;
                cursor: pointer;
            }
            textarea {
                width: 100%;
                min-height: 60px;
                margin-bottom: 10px;
                font-size: 1em;
                resize: vertical;
                box-sizing: border-box;
                background: var(--bg-detail);
                color: var(--text-main);
                border: 1px solid #222;
                border-radius: 6px;
            }
            .small-area {
                min-height: 45px;
                font-size: 0.95em;
            }
            input[type="text"] {
                width: 100%;
                margin-bottom: 1em;
                font-size: 1em;
                box-sizing: border-box;
                background: var(--bg-detail);
                color: var(--text-main);
                border: 1px solid #222;
                border-radius: 6px;
            }
            label {
                color: var(--accent);
                font-weight: 500;
            }
            #submitPromptBtn, #updatePromptBtn {
                background: var(--accent);
                color: #fff;
                padding: 0.75em 1.3em;
                font-size: 1em;
                border: none;
                border-radius: 6px;
                cursor: pointer;
            }
            .hidden {
                display: none !important;
            }
            .title {
                position: relative;
            }
            @media (max-width: 600px) {
                .container {
                    padding: 0.5em;
                }
            }
            .card-details {
                border-top: 1px solid #222;
                background: var(--bg-detail);
                font-size: 1em;
                display: flex;
                flex-direction: column;
                gap: 0.65em;
                transition: max-height 0.25s cubic-bezier(0.65, 0, 0.35, 1);
                max-height: 0;
                overflow: hidden;
                width: 95%;
            }
            .card-details.expanded {
                display: flex;
                max-height: 400px;
                padding-bottom: 1em;
                width: 95%;
            }
            .main-prompt {
                background: var(--prompt-main);
                color: var(--text-main);
                border-radius: 7px;
                padding: 0.45em 0.7em;
                font-family: monospace;
                font-size: 1em;
            }
            .secondary-prompt {
                background: var(--prompt-secondary);
                color: var(--text-secondary);
                border-radius: 7px;
                padding: 0.3em 0.7em;
                font-size: 0.97em;
                font-family: monospace;
            }
            .final-prompt {
                background: var(--final);
                color: #fff;
                border-left: 4px solid var(--accent);
                border-radius: 7px;
                padding: 0.3em 0.7em;
                font-size: 1em;
                font-family: monospace;
                cursor: pointer;
                transition: background 0.2s;
            }
            .final-prompt.copied,
            .main-prompt.copied,
            .secondary-prompt.copied {
                background: #228c52;
            }
            .prompt-labels {
                padding: 0.45em 0.7em;
                font-family: monospace;
                font-size: 1em;
            }
            .empty-textfield {
                display: none;
            }
            .aiNameModelDiv {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                align-content: center;
                justify-content: flex-start;
                align-items: center;
                padding-inline: 0.5rem;
                column-gap: 1rem;
            }
            .ai-name, .model-name {
                font-weight: bold;
                color: #2c4677;
                padding: 0.23em 0.7em;
                background: #eef4fc;
                border-radius: 7px;
                font-size: 1em;
                display: inline-block;
                /* margin-bottom:2px; */
            }
            #editModalForm Input {
                margin-bottom: 1rem;
            }
            .editDelBtnDiv {
                position: absolute;
                top: 10px;
                right: 10px;
                z-index: 2;
                display: flex;
                flex-direction: column;
                flex-wrap: wrap;
                align-content: center;
                justify-content: center;
                align-items: center;
                gap: 1.5rem;

            }
            .edit-btn, .delete-btn {
                /* background: #dddddd; */
                background: #5b5b5b;
                /* border: 1px solid #4a90e2; */
                border: none;
                border-radius: 50%;
                width: 36px;
                height: 36px;
                font-size: 1.3em;
                color: #4a90e2;
                cursor: pointer;
                box-shadow: 0 1px 4px #0002;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
                opacity: 80%;
            }
            .edit-btn:hover {
                /* background: #eaeaea; */
                background: #2d489f;
                /* color: #3069a4; */
                scale: 1.2;
            }
            .edit-btn svg {
                fill: #5ea8ff;
            }
            .delete-btn {
                color: #ff3b3b;
                background: #a7003e;
                border: none;
                transition: all 0.2s ease;
            }
            .delete-btn:hover {
                background: #ff1f1f;
                scale: 1.2;
                
            }
            .fav-btn {
                background: transparent;
                border: none;
                transition: all 0.2s ease;
                z-index: 1000;
            }
            .hidden-cards {
                display: none !important;
            }


        </style>
        <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>
    </head>
    <body>
        <div class="container">
            <div class="addBtn-container">
                <button id="addPromptBtn" class="plus-btn" title="Add new prompt">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M440-120v-320H120v-80h320v-320h80v320h320v80H520v320h-80Z"/></svg>
                </button>
                <div id="prompt-count-text"></div>

            </div>
            <input
                type="text"
                id="searchInput"
                placeholder="Search by Title, Main Prompt, or Rating.."
            />

            
            <div id="cardsContainer"></div>
        </div>
        <div id="modal" class="modal hidden">
            <div class="modal-content">
                <span id="closeModal" class="close">&times;</span>
                <h2 style="margin-top: 0; color: var(--accent)">
                    Add New Prompt
                </h2>
                <form id="modalForm" autocomplete="off">
                    <label for="photoInput">Photo (jpg, png, webp):</label
                    ><br />
                    <input
                        type="file"
                        id="photoInput"
                        accept="image/png,image/jpeg,image/webp"
                    /><br />
                    <label>Title</label>
                    <input type="text" id="titleInput" /><br />
                    <label>AI Name</label>
            
                    <input list="ai-names" id="aiNameInput" />
                    <datalist id="ai-names">
                        <option value="Gemini">
                        <option value="Chat-GPT">
                        <option value="Midjourney">
                        <option value="Leonardo AI">
                    </datalist><br />

                    <label>Model Name</label>
                    <input list="model-names" id="modelNameInput"/>
                    <datalist id="model-names">
                        <option value="2.5 Flash">
                        <option value="2.5 Pro">
                        <option value="GPT-4o mini">
                        <option value="GPT-5 mini">
                    </datalist><br />

                    <label>Rating</label>
                    <input list="rating-datalist" id="rating"/>
                    <datalist id="rating-datalist">
                        <option value="Favourite">
                        <option value="Good">
                        <option value="-">
                    </datalist><br />

                    <label>Main Prompt</label>
                    <textarea id="mainPromptInput" spellcheck="false"></textarea
                    ><br />
                    <label>Prompt Additions</label>
                    <textarea
                        id="secondaryPromptInput"
                        spellcheck="false"
                        class="small-area"
                    ></textarea
                    ><br />
                    <button id="submitPromptBtn" type="submit">Add</button>
                </form>
            </div>
        </div>
        <div id="editModal" class="modal hidden">
            <div class="modal-content">
                <span id="closeEditModal" class="close">&times;</span>
                <h2>Edit Prompt</h2>
                <form id="editModalForm" autocomplete="off">
                <label for="editPhotoInput">Photo</label>
                <input type="file" id="editPhotoInput" accept="image/png, image/jpeg, image/webp"><br/>
                <label>AI Name</label>
                <input list="ai-names" id="editAiNameInput"/><br/>
                <label>Model Name</label>
                <input list="model-names" id="editModelNameInput"/><br/>
                <label>Rating</label>
                <input list="rating-datalist" id="editRating"/><br/>
                <label>Title</label>
                <input type="text" id="editTitleInput"/><br/>
                <label>Main Prompt</label>
                <textarea id="editMainPromptInput" spellcheck="false"></textarea><br/>
                <label>Secondary Prompt</label>
                <textarea id="editSecondaryPromptInput" spellcheck="false" class="small-area"></textarea><br/>
                <button id="updatePromptBtn" type="submit">Update</button>
                </form>
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", function () {

                // These 2 variables needs to be changed for future variants/forks of this App.
                const collectionName = "prompts_300h";
                let firestoreUploadDownscaledHeight = 300; //Resizing height value of the photo in px
                console.log("FireStore Collection: " + collectionName); // For Debugging

                // Firebase config fill in as needed
                const firebaseConfig = {
                    apiKey: "AIzaSyBGM_ws-4leOmvLLzIEU62y36cHLjYeezQ",
                    authDomain: "my-bookmarks-01.firebaseapp.com",
                    projectId: "my-bookmarks-01",
                    storageBucket: "my-bookmarks-01.firebasestorage.app",
                    messagingSenderId: "202931759065",
                    appId: "1:202931759065:web:ccfa3cf456370d839a5bc8",
                };
                firebase.initializeApp(firebaseConfig);
                const db = firebase.firestore();
                
                let promptsCount = 0; // To Track total no. of entries in the database
                let editingCardElement; // To access the currently editing card element
                let editingPhotoBase64; // To store the existing base64 string before any change (if any)

                // Function to resize the photo to firestoreUploadDownscaledHeight variable & Convert to Base64
                function fileToBase64(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => {
                            const img = new Image();
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                const targetHeight = firestoreUploadDownscaledHeight;
                                const aspectRatio = img.width / img.height;
                                canvas.height = targetHeight;
                                canvas.width = targetHeight * aspectRatio;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                // You can adjust the JPEG quality here (0.1 to 1)
                                const resizedBase64 = canvas.toDataURL('image/jpeg', 1);
                                resolve(resizedBase64);
                            };
                            img.onerror = reject;
                            img.src = reader.result;
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                }

                const cardsContainer = document.getElementById("cardsContainer");
                const modal = document.getElementById("modal");
                const addPromptBtn = document.getElementById("addPromptBtn");
                const closeModalBtn = document.getElementById("closeModal");
                const modalForm = document.getElementById("modalForm");
                const promptsCountText = document.getElementById("prompt-count-text");
                const expandSvg = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 transform transition-transform" id="arrowSvg">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                </svg>`;
                const collapseSvg = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>`;
                const deleteBtnSvg = `<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="m376-300 104-104 104 104 56-56-104-104 104-104-56-56-104 104-104-104-56 56 104 104-104 104 56 56Zm-96 180q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520Zm-400 0v520-520Z"/></svg>`;
                const favBtnSvg = `<svg width="24px" height="24px" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M1.24264 8.24264L8 15L14.7574 8.24264C15.553 7.44699 16 6.36786 16 5.24264V5.05234C16 2.8143 14.1857 1 11.9477 1C10.7166 1 9.55233 1.55959 8.78331 2.52086L8 3.5L7.21669 2.52086C6.44767 1.55959 5.28338 1 4.05234 1C1.8143 1 0 2.8143 0 5.05234V5.24264C0 6.36786 0.44699 7.44699 1.24264 8.24264Z"/>
                </svg>`;

                function showModal() {
                    modal.classList.remove("hidden");
                }
                function hideModal() {
                    modal.classList.add("hidden");
                }
                document.getElementById('closeEditModal').onclick = function() {
                    document.getElementById('editModal').classList.add('hidden');
                };


                addPromptBtn.addEventListener("click", showModal);
                closeModalBtn.addEventListener("click", hideModal);
                window.addEventListener("keydown", function (e) {
                    if (e.key === "Escape") {
                        hideModal();
                    }
                });

                // Function to Add New Entry to the Firestore Database
                modalForm.addEventListener("submit", async function (event) {
                    event.preventDefault();
                    let isSecondPromptEmpty = false;
                    const photoFile = document.getElementById("photoInput").files[0];
                        
                    const title = document.getElementById("titleInput").value.trim();
                    const aiName = document.getElementById("aiNameInput").value || "";
                    const modelName = document.getElementById("modelNameInput").value || "";
                    const rating = document.getElementById("rating").value || "-";

                    const mainPrompt = document.getElementById("mainPromptInput").value.trim();
                    const secondaryPrompt = document.getElementById("secondaryPromptInput").value.trim();

                    if (secondaryPrompt == "") {isSecondPromptEmpty = true;}
                    if (!photoFile || !title || !mainPrompt) {
                        alert("Photo, Title, and Main Prompt are required.");
                        return;
                    }
                    const photoBase64 = await fileToBase64(photoFile);
                    //navigator.clipboard.writeText(photoBase64); // For Debugging

                    const newDoc = {
                        photo: photoBase64,
                        aiName,
                        modelName,
                        title,
                        rating,
                        mainPrompt,
                        secondaryPrompt,
                        timestamp: Date.now()
                    };
                    db.collection(collectionName)
                        .add(newDoc)
                        .then((docRef) => {
                            renderCard(newDoc, docRef.id, isSecondPromptEmpty); // To display the new card
                            modalForm.reset();
                            hideModal();
                            promptsCount++;
                            updatePromptsCount();
                        });
                });

                // Function to Edit/Update any existing entry to Firestore Database
                document.getElementById('editModalForm').onsubmit = async function(e) {
                    e.preventDefault();
                    const id = window.editingDocId;
                    console.log("Updated doc id: " + id); // For Debugging
                    let isSecondPromptEmpty = false;
                    const aiName = document.getElementById("editAiNameInput").value || "";
                    const modelName = document.getElementById("editModelNameInput").value || "";
                    const rating = document.getElementById("editRating").value || "-";
                    const title = document.getElementById("editTitleInput").value.trim();
                    const mainPrompt = document.getElementById("editMainPromptInput").value.trim();
                    const secondaryPrompt = document.getElementById("editSecondaryPromptInput").value.trim();
                    // Get original photo unless replaced
                    let photo = editingPhotoBase64; // you can set this on open
                    //console.log(photo); // For Debugging
                    const fileInput = document.getElementById("editPhotoInput");
                    if(fileInput.files && fileInput.files[0]) {
                        const photoBase64 = await fileToBase64(fileInput.files[0]);
                        photo = photoBase64;
                    }
                    let timestamp = Date.now();

                    // Update Firestore
                    await db.collection(collectionName).doc(id).set({
                        photo, aiName, modelName, rating, title, mainPrompt, secondaryPrompt, timestamp
                    });
                    if (secondaryPrompt == "") {isSecondPromptEmpty = true;}
                    const oldCardElement = editingCardElement;
                    if (oldCardElement) oldCardElement.remove();
                    
                    db.collection(collectionName).doc(id).get().then((doc) => {
                        if (doc.exists) {
                            renderCard(doc.data(), doc.id, isSecondPromptEmpty);
                        }
                    });

                    document.getElementById('editModal').classList.add('hidden');
                    // Show a popup message (simple)
                    alert("Data updated");
                };


                function hideEmptyTextFields(element) {
                    element.classList.add("empty-textfield");
                }
                function updatePromptsCount() {
                    promptsCountText.textContent = `Prompts Count: ${promptsCount}`;
                }

                // Function to Display/Render the data to a Card
                function renderCard(docData, id, isSecondPromptEmpty) {
                    const img = new Image();
                    img.src = docData.photo;
                    img.onload = function () {
                        const aspectRatio =
                            img.naturalWidth / img.naturalHeight;
                        const width = Math.round(400 * aspectRatio);
                        const cardDiv = document.createElement("div");
                        cardDiv.className = "card";
                        // To Add Rating key value as an atrribute to the Card element
                        cardDiv.setAttribute("data-rating", (docData.rating || "").toLowerCase());
                        const imgTag = document.createElement("img");
                        imgTag.src = docData.photo;
                        imgTag.style.height = "400px";
                        imgTag.style.width = width + "px";
                        cardDiv.appendChild(imgTag);
                        const titleDiv = document.createElement("div");
                        titleDiv.className = "title";
                        titleDiv.textContent = docData.title;
                        cardDiv.appendChild(titleDiv);

                        // Container for Edit & Delete Buttons
                        const editDelBtnDiv = document.createElement("div");
                        editDelBtnDiv.className = "editDelBtnDiv";
                        cardDiv.appendChild(editDelBtnDiv);

                        // Edit Button
                        const editBtn = document.createElement("button");
                        editBtn.textContent = "âœŽ";
                        editBtn.title = "Edit";
                        editBtn.className = "edit-btn";
                        editDelBtnDiv.appendChild(editBtn);

                        // Delete Button
                        const deleteBtn = document.createElement("button");
                        deleteBtn.innerHTML = deleteBtnSvg;
                        deleteBtn.title = "Delete";
                        deleteBtn.className = "delete-btn";
                        editDelBtnDiv.appendChild(deleteBtn);

                        // Fav. Button (Rating Value)
                        const favBtn = document.createElement("button");
                        favBtn.innerHTML = favBtnSvg;
                        const svgPath = favBtn.querySelector("svg path");
                        if (docData.rating ==="Favourite"){
                            svgPath.setAttribute("fill", "red");
                        }else {
                            svgPath.setAttribute("fill", "#5b5b5b");
                        }
                        
                        favBtn.title = "Add to Favourites";
                        favBtn.className = "fav-btn";
                        editDelBtnDiv.appendChild(favBtn);

                        // Expand/Collapse Arrow Button
                        const expandBtn = document.createElement("button");
                        expandBtn.className = "expand-btn";
                        expandBtn.setAttribute("aria-expanded", "false");
                        expandBtn.innerHTML = expandSvg; // Down arrow
                        //cardDiv.appendChild(expandBtn); // Older Code
                        titleDiv.appendChild(expandBtn);

                        // Details Panel
                        const detailsDiv = document.createElement("div");
                        detailsDiv.className = "card-details";
                        detailsDiv.setAttribute("aria-hidden", "true");
                        
                        // Container for Ai Name & Ai Model Data
                        const aiNameModelDiv = document.createElement("div");
                        aiNameModelDiv.className = "aiNameModelDiv";

                        // Ai Name
                        const aiNameDiv = document.createElement("div");
                        aiNameDiv.className = "ai-name";
                        aiNameDiv.textContent = docData.aiName || "";
                        aiNameModelDiv.appendChild(aiNameDiv);

                        // Model Name
                        const modelNameDiv = document.createElement("div");
                        modelNameDiv.className = "model-name";
                        modelNameDiv.textContent = docData.modelName || "";
                        aiNameModelDiv.appendChild(modelNameDiv);

                        detailsDiv.appendChild(aiNameModelDiv);

                        // Main prompt
                        const mainPromptLabel = document.createElement("span");
                        mainPromptLabel.className = "prompt-labels";
                        mainPromptLabel.textContent = "Main Prompt";
                        detailsDiv.appendChild(mainPromptLabel);

                        const mainPromptSpan = document.createElement("span");
                        mainPromptSpan.className = "main-prompt";
                        mainPromptSpan.textContent = docData.mainPrompt;
                        addCopyClick(mainPromptSpan); // Apply "Click to" Function
                        detailsDiv.appendChild(mainPromptSpan);

                        // Secondary prompt
                        const secondPromptLabel = document.createElement("span");
                        secondPromptLabel.className = "prompt-labels";
                        secondPromptLabel.textContent = "Prompt Additions";
                        detailsDiv.appendChild(secondPromptLabel);

                        const secondaryPromptSpan = document.createElement("span");
                        secondaryPromptSpan.className = "secondary-prompt";
                        secondaryPromptSpan.textContent = docData.secondaryPrompt;
                        addCopyClick(secondaryPromptSpan); // Apply "Click to" Function
                        detailsDiv.appendChild(secondaryPromptSpan);

                        // Final prompt: main prompt + newline + secondary prompt
                        const finalPromptLabel = document.createElement("span");
                        finalPromptLabel.className = "prompt-labels";
                        finalPromptLabel.textContent = "Final Prompt";
                        detailsDiv.appendChild(finalPromptLabel);

                        const finalPromptDiv = document.createElement("span");
                        finalPromptDiv.className = "final-prompt";
                        // Code to join Main & Prompt Additions Texts
                        finalPromptDiv.textContent = docData.mainPrompt + "\n" + docData.secondaryPrompt;
                        addCopyClick(finalPromptDiv); // Apply "Click to" Function
                        //finalPromptDiv.title = "Click to copy";
                        detailsDiv.appendChild(finalPromptDiv);

                        // Code to Hide Prompt Additions & Final prompt fields if Prompt Additions is empty
                        if (isSecondPromptEmpty) {
                            hideEmptyTextFields(secondPromptLabel);
                            hideEmptyTextFields(secondaryPromptSpan);
                            hideEmptyTextFields(finalPromptLabel);
                            hideEmptyTextFields(finalPromptDiv);
                        }

                        // Initial collapse
                        detailsDiv.classList.remove("expanded");
                        detailsDiv.style.maxHeight = "0";
                        detailsDiv.setAttribute("aria-hidden", "true");
                        cardDiv.appendChild(detailsDiv);

                        // Expand/collapse toggle
                        expandBtn.onclick = function () {
                            if (detailsDiv.classList.contains("expanded")) {
                                detailsDiv.classList.remove("expanded");
                                detailsDiv.style.maxHeight = "0";
                                detailsDiv.setAttribute("aria-hidden", "true");
                                //expandBtn.innerHTML = expandSvg;
                                const svg1 = expandBtn.querySelector('svg');
                                svg1.classList.remove('rotate-svg-180');
                                expandBtn.setAttribute(
                                    "aria-expanded",
                                    "false"
                                );
                            } else {
                                detailsDiv.classList.add("expanded");
                                detailsDiv.style.maxHeight =
                                    detailsDiv.scrollHeight + "px";
                                detailsDiv.setAttribute("aria-hidden", "false");
                                //expandBtn.innerHTML = collapseSvg;
                                const svg2 = expandBtn.querySelector('svg');
                                svg2.classList.add('rotate-svg-180');
                                //expandBtn.classList.add('rotate-svg-180');
                                expandBtn.setAttribute("aria-expanded", "true");
                            }
                        };

                        editBtn.onclick = () => {
                            document.getElementById('editModal').classList.remove('hidden');
                            // Store current doc id being edited (best to use a variable outside renderCard, e.g., window.editingDocId)
                            window.editingDocId = id;
                            //console.log("Editing doc id: " + id); // For Debugging
                            editingCardElement = event.target.parentElement.parentElement;
                            //console.log(event.target.parentElement.parentElement); // For Debugging

                            // Pre-fill fields
                            //console.log(docData.photo); // For Debugging
                            editingPhotoBase64 = docData.photo;
                            document.getElementById('editAiNameInput').value = docData.aiName || "";
                            document.getElementById('editModelNameInput').value = docData.modelName || "";
                            document.getElementById('editRating').value = docData.rating || "-";
                            document.getElementById('editTitleInput').value = docData.title;
                            document.getElementById('editMainPromptInput').value = docData.mainPrompt;
                            document.getElementById('editSecondaryPromptInput').value = docData.secondaryPrompt;
                            // Don't clear photo preview unless they pick a new file.
                        };

                        deleteBtn.addEventListener("click", async () => {
                            console.log("id of the card to be deleted: " + id); // For Debugging
                            const confirmed = window.confirm("Delete this card Permanently?");
                            if (!confirmed) {
                                return; // Abort if user says No/Cancel
                            }
                            try {
                                await db.collection(collectionName).doc(id).delete();  // delete from Firestore
                                cardDiv.remove(); // remove card element from DOM
                                alert("The Card is Deleted!");
                                promptsCount = promptsCount-1;
                                updatePromptsCount();
                            } catch (error) {
                                alert("Error deleting card: " + error.message);
                            }
                        });

                        favBtn.addEventListener("click", function () {
                            /* console.log("Clicked!!!"); // For Debugging */
                            const svgPath = this.querySelector("svg path");
                            //console.log(svgPath); // For Debugging
                            if (!svgPath) {
                                console.log("svg path not found!"); // For Debugging
                                return;
                            }
                            // Get current color from inline fill attribute or computed style
                            let currentFill = svgPath.getAttribute("fill");
                            // console.log(docData.rating); // For Debugging
                            const docRef = db.collection(collectionName).doc(id).get().then((doc) => {
                                let currentRating = doc.data().rating;
                                if (currentRating != "Favourite") {
                                    // Code to change the rating to "Favourite"
                                    let rating = "Favourite";
                                    db.collection(collectionName).doc(id).set({ rating }, { merge: true });
                                    svgPath.setAttribute("fill", "red");
                                }else {
                                    // Code to Remove the Rating "Favourite"
                                    let rating = "-";
                                    db.collection(collectionName).doc(id).set({ rating }, { merge: true });
                                    svgPath.setAttribute("fill", "#5b5b5b");
                                }
                            });
                        });

                        // Add New Card as a First Card on Top
                        cardsContainer.prepend(cardDiv);
                        //cardsContainer.appendChild(cardDiv); // Old Code

                    };
                }

                hideModal(); // Ensure modal hidden at start
                db.collection(collectionName)
                    .orderBy('timestamp', 'asc')
                    .get()
                    .then((querySnapshot) => {
                        promptsCount = 0;
                        querySnapshot.forEach((doc) => {
                            promptsCount++;
                            
                            let isSecondPromptEmpty = false;
                            if (doc.data().secondaryPrompt == "") {
                                isSecondPromptEmpty = true;

                            }
                            renderCard(doc.data(), doc.id, isSecondPromptEmpty);
                        });
                        updatePromptsCount();
                    });


                // Copy to clipboard helper with feedback
                function addCopyClick(element) {
                    element.style.cursor = "pointer";
                    element.title = "Click to copy";
                    element.onclick = () => {
                        navigator.clipboard
                            .writeText(element.textContent)
                            .then(() => {
                                element.classList.add("copied");
                                setTimeout(
                                    () => element.classList.remove("copied"),
                                    200
                                );
                            });
                    };
                }
                
                const searchInput = document.getElementById("searchInput");

                function filterCards() {
                    const searchValue = searchInput.value.toLowerCase().trim();

                    // Split by comma and trim, filter out empty terms
                    const searchTerms = searchValue
                        .split(",")
                        .map(term => term.trim())
                        .filter(term => term.length > 0);
                    let matchCount = 0;
                    // For each card, check if it matches all terms (AND)
                    document.querySelectorAll(".card").forEach(card => {
                        const title = card.querySelector(".title")?.textContent.toLowerCase() || "";
                        const mainPrompt = card.querySelector(".main-prompt")?.textContent.toLowerCase() || "";
                        const rating = (card.getAttribute("data-rating") || "").toLowerCase();
                        
                        // Check each search term against the 3 fields
                        const matchesAll = searchTerms.every(term => {
                            // To match term at start of word use regex with \b prefix
                            const regex = new RegExp(`\\b${term}`, "i");
                            return regex.test(title) || regex.test(mainPrompt) || regex.test(rating);
                        });

                        // Toggle hidden class
                        if (matchesAll) {
                            card.classList.remove("hidden-cards");
                            matchCount ++;
                        } else {
                            card.classList.add("hidden-cards");
                        }
                    });
                    promptsCount = matchCount;
                    updatePromptsCount();
                }

                // Listen for input changes
                searchInput.addEventListener("input", filterCards);

                


            });

        </script>
    </body>
</html>
